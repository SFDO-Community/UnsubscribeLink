minimum_cumulusci_version: '3.86.1'
project:
    name: Unsubscribe-Link
    package:
        name: Unsubscribe-Link
        namespace: UnsubscribeLnk
        api_version: '60.0'
    git:
        default_branch: 'main'
    source_format: sfdx

tasks:
    robot:
        options:
            suites: robot/Unsubscribe-Link/tests
            options:
                outputdir: robot/Unsubscribe-Link/results

    robot_testdoc:
        options:
            path: robot/Unsubscribe-Link/tests
            output: robot/Unsubscribe-Link/doc/Unsubscribe-Link_tests.html

    run_tests:
        options:
            required_org_code_coverage_percent: 75

    install_v3:
        description: install the older SF Labs version 3 of Unsubscribe Link. Useful for upgrade testing
        class_path: cumulusci.tasks.command.Command
        options:
            command: sf package install --package 04t4W000002kcU0QAI

    install_v4-prerelease:
        description: install the pre-release packaged version of the Commons version of Unsubscribe Link. Used in the March 2025 sprint, but should be deprecated after the package is released in favor of default CCI tasks.
        class_path: cumulusci.tasks.command.Command
        options:
            command: sf package install --package 04taj000000471JAAQ

    labs_upgrade_package:
        description: Installs metadata used for a scripted migration from the Salesforce Labs package to the Commons managed package.
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/labs-upgrade

flows:
    customer_org:
        description: Flow that installs the managed version and, optionally, the upgrade package into a customer org
        steps:
            1:
                task: install_managed


plans:
    install:
        slug: install
        title: Base Install
        tier: primary
        is_listed: true
        preflight_message: This will install Unsubscribe Link into your org.
        steps:
            1:
                flow: customer_org

    lab-upgrade:
        slug: labs-upgrade
        title: Salesforce Labs Upgrade Path
        is_listed: true
        preflight_message: For orgs upgrading from Salesforce labs, install a migration tool for moving old Unsubscribe records to the new managed object.
        post_install_message: "Within your org, run the 'Unsubscribe: Data Migration Flow' screen flow to kick off the data migration batch."
        checks:
            - when: "'jrsl_ul_Unsubscribe__c' not in tasks.check_sobjects_available()"
              action: error
              message: "This plan is only accessible if you have previously installed the Salesforce Labs version of the application in your org."
        steps:
            1:
                task: labs_upgrade_package